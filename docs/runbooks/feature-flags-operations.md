# Feature Flags Operations Runbook

> Governs Flagsmith usage per `docs/adr/ADR-005-feature-flags.md` and `docs/PRDs/requierments/feature-flags/feature-requirements.md`.

## Purpose
- Provide a repeatable process for managing feature toggles, experiments, and production fallbacks.
- Ensure flags stay governed with owner accountability, cached defaults, and safe rollback paths.

## Scope
- Flagsmith environments: `dev`, `prod`.
- Applies to any code path relying on `MissionConfigurationManager`, app shell providers, or edge middleware.
- Excludes marketing campaign parameters (handled by analytics runbooks).

## Preconditions
- Engineering and product approvers listed in Flagsmith RBAC.
- `mission-config-enabled`, `feature-flags-enabled`, or other mission-linked flags registered with owner, description, sunset date.
- Cached default JSON stored in `config/flags/defaults.json` (regenerated by CI nightly).

## Tooling & References
- Flagsmith dashboard (`https://app.flagsmith.com`) with SSO.
- `npm run flags:report` — generates owner + sunset inventory for audit.
- Grafana Loki dashboard `Feature Flags / Evaluation Health`.
- CI stale flag job (`.github/workflows/flags-stale.yml`).
- Slack `#clarivum-launchpad` — approvals, freeze notices.

## Standard Operating Procedures
### 1. Flag Proposal & Creation
- Product owner files task referencing PRD requirement and sunset plan.
- Engineering owner defines key, description, default state (dev on, prod off), rollout cohort, fallback behavior.
- Create flag in dev environment only; link Linear/Jira ticket in Flagsmith notes.
- Run `npm run flags:report` to ensure inventory includes new entry.

### 2. Rollout & Approval Workflow
1. Engineering validates flag behavior in dev/preview.
2. Product reviews experience via preview link; both approve in Flagsmith audit comments.
3. Engineering toggles flag in prod with product approver present on call (dual-approval requirement).
4. Monitor Grafana dashboard for 15 minutes; confirm evaluation latency <50 ms and error rate <0.1%.
5. Update task with rollout timestamp and target cohort.

### 3. Experiment Management
- Configure multivariate values in Flagsmith.
- Document experiment hypothesis, target metrics, start/end dates in inventory sheet.
- Sync experiment variant identifiers with analytics team for funnel attribution.
- At experiment end, export variant results and update Flagsmith to winning variant or retire flag.

### 4. Cached Defaults Maintenance
- Nightly CI job exports Flagsmith state to `config/flags/defaults.json`.
- If CI fails, on-call engineer reruns `npm run flags:export` locally and commits update.
- Ensure defaults reflect safe/off behavior for high-risk features; review monthly.

### 5. Stale Flag Audit
- Weekly on Mondays, owner reviews stale report posted by CI.
- If `sunset_date` passed:
  - Option A: remove flag from code within 5 business days.
  - Option B: update sunset date with justification and new task link.
- Document action in Flagsmith notes and team channel.

## Incident Response
### Flagsmith Outage / Elevated Latency
1. Detect via Grafana alert (`Flagsmith latency > 200 ms` or `evaluation errors > 1%`).
2. Validate cached defaults are serving by checking application logs.
3. Enable `flagsmith_failover_mode` flag (local config) to force default values.
4. Notify `#clarivum-alerts` and product stakeholders; include impacted features.
5. Once Flagsmith recovers, gradually disable failover and monitor metrics for 30 minutes.

### Misconfigured Toggle / Bad Rollout
1. Toggle flag back to previous state (if safe) or disable feature via fallback flag.
2. Announce rollback and blast radius in `#clarivum-launchpad`.
3. Capture timeline and root cause in post-incident doc; update flag notes with learnings.

## Governance Checklist
- [ ] Every flag has owner, description, rollout plan, sunset date.
- [ ] Dual approval logged for prod toggles.
- [ ] Cached defaults verified after each new high-risk flag.
- [ ] Stale flag report reviewed weekly.
- [ ] Experiments closed with documented decision.

## Escalation Matrix
- Level 1: On-call engineer (feature flag steward of week).
- Level 2: Platform lead (handles extended outages or SDK bugs).
- Level 3: CTO for vendor escalation or SLA breach.
- Notify analytics lead when experiments impacted >4 hours.

## Maintenance
- Review runbook quarterly; sync changes with `docs/adr/ADR-005-feature-flags.md`.
- Update tooling links after Flagsmith UI or workflow changes.
